<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pedido de Brigadeiros</title>
  <style>
    :root{
      --brand:#2A68D8; --bg:#f7f8fa; --card:#ffffff; --text:#1e1e1e; --muted:#6b7280; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial; background:var(--bg); color:var(--text)}
    .wrap{max-width:900px; margin:24px auto 80px; padding:0 16px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:18px; box-shadow:0 3px 12px rgba(0,0,0,.04)}
    h1{font-size:24px; margin:0 0 12px}
    .grid{display:grid; gap:12px}
    .grid-2{grid-template-columns:1fr 1fr}
    label{font-weight:600; font-size:14px}
    input[type="text"], input[type="date"], textarea{
      width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:10px; font-size:15px; background:#fff;
    }
    textarea{min-height:90px; resize:vertical}
    .flavors{display:grid; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr)); gap:10px}
    .flavor{display:flex; align-items:center; justify-content:space-between; gap:10px; border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:#fff}
    .flavor span{font-size:14px}
    .qty{display:flex; align-items:center; gap:6px}
    .qty button{width:32px; height:32px; border:1px solid var(--border); background:#fff; border-radius:8px; font-size:18px; cursor:pointer}
    .qty input{width:64px; text-align:center; padding:8px; border:1px solid var(--border); border-radius:8px; font-size:15px}
    .row{display:grid; grid-template-columns:1fr; gap:10px}
    .totals{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border:1px dashed var(--border); border-radius:10px; background:#fafafa; font-weight:600}
    .btns{display:flex; flex-wrap:wrap; gap:8px}
    button.primary{
      background:var(--brand); color:#fff; border:none; padding:12px 16px; border-radius:10px; font-weight:700; cursor:pointer;
    }
    button.secondary{
      background:#fff; color:#111; border:1px solid var(--border); padding:12px 16px; border-radius:10px; font-weight:600; cursor:pointer;
    }
    pre{white-space:pre-wrap; background:#0f172a; color:#e2e8f0; padding:12px; border-radius:10px; font-size:13px; overflow:auto}
    .muted{color:var(--muted); font-size:13px}
    @media (min-width:760px){ .row.grid-2{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Formul√°rio de Pedido ‚Äî Brigadeiros</h1>
      <p class="muted">Preencha o nome do cliente, a data do pedido e selecione as quantidades por sabor.</p>

      <div class="grid row grid-2" style="margin:12px 0">
        <div>
          <label for="clientName">Nome do cliente</label>
          <input id="clientName" type="text" placeholder="Ex.: Jo√£o Silva" />
        </div>
        <div>
          <label for="orderDate">Data do pedido</label>
          <input id="orderDate" type="date" />
        </div>
      </div>

      <div class="grid" style="margin:8px 0 2px">
        <label>Sabores & Quantidades</label>
        <div id="flavors" class="flavors"></div>
      </div>

      <div class="grid" style="margin:8px 0">
        <label for="notes">Observa√ß√µes</label>
        <textarea id="notes" placeholder="Ex.: sem granulado, separar por sabores, etc."></textarea>
      </div>

      <div class="totals" style="margin:12px 0">
        <div>Total de unidades: <span id="totalUnits">0</span></div>
        <div>Sabores selecionados: <span id="selectedCount">0</span></div>
      </div>

      <div class="btns" style="margin-top:6px">
        <button id="makeOrder" class="primary">Gerar Pedido</button>
        <button id="copyTxt" class="secondary" disabled>Copiar texto</button>
        <button id="openWhats" class="secondary" disabled>Abrir no WhatsApp</button>
        <button id="saveJSON" class="secondary" disabled>Baixar JSON</button>
        <button id="saveCSV" class="secondary" disabled>Baixar CSV</button>
      </div>

      <div id="outputWrap" style="display:none; margin-top:14px">
        <h3>Resumo</h3>
        <pre id="orderText"></pre>
      </div>

      <p class="muted">O WhatsApp j√° est√° fixo para: <b>+55 11 97313-3475</b>.</p>
    </div>
  </div>

  <script>
    // ‚úÖ Seu n√∫mero fixo (apenas d√≠gitos, sem +):
    const YOUR_WHATS_NUMBER = "5511973133475";

    const FLAVORS = [
      "Tradicional",
      "Ninho com Nutella",
      "Ninho com Uva",
      "Pa√ßoca",
      "Beijinho",
      "Churros",
      "Bicho de P√©",
      "Casadinho",
      "Oreo"
    ];

    // Helpers
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const flavorsEl = $("#flavors");
    const totalUnitsEl = $("#totalUnits");
    const selectedCountEl = $("#selectedCount");
    const clientNameEl = $("#clientName");
    const orderDateEl = $("#orderDate");
    const notesEl = $("#notes");

    // Preencher data de hoje
    const today = new Date();
    orderDateEl.value = today.toISOString().slice(0,10);

    // Persistir nome do cliente localmente
    clientNameEl.value = localStorage.getItem("brig_clientName") || "";
    clientNameEl.addEventListener("input", () => {
      localStorage.setItem("brig_clientName", clientNameEl.value.trim());
    });

    // Montar lista de sabores
    FLAVORS.forEach((name, idx) => {
      const row = document.createElement("div");
      row.className = "flavor";
      row.innerHTML = `
        <span>${name}</span>
        <div class="qty">
          <button type="button" data-act="minus" aria-label="diminuir">‚àí</button>
          <input type="number" min="0" step="1" value="0" inputmode="numeric" id="qty_${idx}">
          <button type="button" data-act="plus" aria-label="aumentar">+</button>
        </div>
      `;
      row.querySelectorAll("button").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const inp = row.querySelector("input");
          const v = parseInt(inp.value||"0",10);
          if(btn.dataset.act==="plus") inp.value = v+1;
          else inp.value = Math.max(0, v-1);
          recomputeTotals();
        });
      });
      row.querySelector("input").addEventListener("input", recomputeTotals);
      flavorsEl.appendChild(row);
    });

    function getQuantities(){
      return FLAVORS.map((name, i)=>{
        const val = parseInt($("#qty_"+i).value || "0", 10);
        return { flavor:name, qty: isNaN(val)?0:val };
      });
    }

    function recomputeTotals(){
      const list = getQuantities();
      const total = list.reduce((s,i)=>s+i.qty,0);
      const selected = list.filter(i=>i.qty>0).length;
      totalUnitsEl.textContent = total;
      selectedCountEl.textContent = selected;
    }
    recomputeTotals();

    function ddmmyyyy(dateStr){
      const [y,m,d] = dateStr.split("-");
      if(!y||!m||!d) return dateStr || "";
      return `${d}/${m}/${y}`;
    }

    function buildOrder(){
      const name = clientNameEl.value.trim();
      const date = orderDateEl.value;
      const notes = notesEl.value.trim();
      const items = getQuantities().filter(i=>i.qty>0);

      return {
        clientName: name || "(sem nome)",
        orderDate: date || "",
        orderDate_br: date ? ddmmyyyy(date) : "",
        notes,
        items,
        totalUnits: items.reduce((s,i)=>s+i.qty,0)
      };
    }

    function toText(order){
      const header = `Pedido de Brigadeiros\nCliente: ${order.clientName}\nData: ${order.orderDate_br || "-"}\n`;
      const lines = order.items.map(i=>`‚Ä¢ ${i.flavor}: ${i.qty}`);
      const obs = order.notes ? `\nObserva√ß√µes: ${order.notes}` : "";
      const total = `\nTotal de unidades: ${order.totalUnits}`;
      return `${header}\nSabores:\n${lines.join("\n")}${total}${obs}`;
    }

    function toCSV(order){
      const rows = [["Cliente","Data","Sabor","Quantidade","Observa√ß√µes"]];
      if(order.items.length===0){
        rows.push([order.clientName, order.orderDate_br, "-", 0, order.notes||""]);
      } else {
        order.items.forEach(i=>{
          rows.push([order.clientName, order.orderDate_br, i.flavor, i.qty, order.notes||""]);
        });
      }
      return rows.map(r=>r.map(cell=>{
        const s = String(cell??"");
        return /[",\n;]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(";")).join("\n");
    }

    function download(filename, content, mime){
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([content], {type:mime}));
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    const makeOrderBtn = $("#makeOrder");
    const copyBtn = $("#copyTxt");
    const whatsBtn = $("#openWhats");
    const jsonBtn = $("#saveJSON");
    const csvBtn = $("#saveCSV");
    const outputWrap = $("#outputWrap");
    const orderTextPre = $("#orderText");

    makeOrderBtn.addEventListener("click", ()=>{
      const order = buildOrder();
      const text = toText(order);

      orderTextPre.textContent = text;
      outputWrap.style.display = "block";

      copyBtn.disabled = false;
      jsonBtn.disabled = false;
      csvBtn.disabled = false;
      whatsBtn.disabled = false;

      // salva √∫ltimo pedido
      localStorage.setItem("brig_lastOrder", JSON.stringify(order));

      // üî• abre WhatsApp automaticamente com seu n√∫mero fixo
      const url = `https://wa.me/${YOUR_WHATS_NUMBER}?text=${encodeURIComponent(text)}`;
      window.open(url, "_blank");
    });

    // Bot√£o manual "Abrir no WhatsApp" (se precisar reabrir)
    whatsBtn.addEventListener("click", ()=>{
      const currentText = orderTextPre.textContent || toText(buildOrder());
      const url = `https://wa.me/${+5511973133475}?text=${encodeURIComponent(currentText)}`;
      window.open(url, "_blank");
    });

    copyBtn.addEventListener("click", async ()=>{
      const txt = orderTextPre.textContent;
      try{
        await navigator.clipboard.writeText(txt);
        copyBtn.textContent = "Copiado!";
        setTimeout(()=>copyBtn.textContent="Copiar texto",1200);
      }catch{
        alert("N√£o foi poss√≠vel copiar automaticamente. Selecione o texto e copie manualmente.");
      }
    });

    jsonBtn.addEventListener("click", ()=>{
      const order = buildOrder();
      download(`pedido-${order.clientName || "cliente"}-${Date.now()}.json`, JSON.stringify(order, null, 2), "application/json");
    });

    csvBtn.addEventListener("click", ()=>{
      const order = buildOrder();
      download(`pedido-${order.clientName || "cliente"}-${Date.now()}.csv`, toCSV(order), "text/csv;charset=utf-8");
    });
  </script>
</body>
</html>
